# 产品需求文档 (PRD)：BaoMiHua (豹米花) - 终端 AI 专属指令助手

## 1. 产品概述

* **产品名称：** BaoMiHua (中文：豹米花)
* **产品别名 (Alias)：** `bmh` 或 `bao`
* **产品定位：** 一只存在于终端里的“孟加拉豹猫”。基于 Go 语言构建，具备极速冷启动和高颜值 UI。它能敏锐感知当前操作系统与 Shell 环境，将开发者的自然语言转化为精准的 Shell 命令，并提供安全、无缝的交互执行体验。

## 2. 核心架构与技术栈选型

* **命令路由与骨架：** `Cobra`
* **配置与环境变量管理：** `Viper`
* **终端交互式 UI 状态机：** `Bubble Tea` + `Lip Gloss` (样式)
* **加载动画：** `bubbles/spinner`

*(注：Bubble Tea 基于 Elm 架构，通过 Model-Update-View 的单向数据流来优雅管理复杂的终端 UI 状态)*

## 3. 功能需求与交互流程

### 3.1 核心命令与触发

通过极其简短的别名触发对话，参数即为提示词。

* **标准输入：** `bmh 查出占用 8080 端口的进程并强制杀掉`
* **加载状态 (Loading)：** 终端渲染流畅的 Spinner 动画，并配以符合产品调性的文案。
* *UI 展示：* `🐆 豹米花正在潜伏思考如何“查出占用...”`



### 3.2 结果展示与交互菜单 (Bubble Tea 视图)

当大模型返回结果后，清空 Loading 状态，渲染结构化卡片与操作菜单。

* **UI 布局规范：**
```text
🎯 目标锁定 (命令): lsof -ti:8080 | xargs kill -9
💡 豹猫解析 (解释): lsof 查找 8080 端口 PID，xargs 传递给 kill 强制结束。

请选择下一步动作:
> 1. 🐾 插入终端 (Insert to prompt)  <-- 默认高亮推荐
  2. ⚡️ 直接执行 (Execute)
  3. 📋 复制命令 (Copy)
  4. 🛑 放弃 (Cancel)

```


* **核心动作实现逻辑：**
* **插入终端 (高优核心特性)：** 工具退出，利用 Shell 函数 Wrapper (如 `print -z` 或 `READLINE_LINE`)，将命令填入父进程的光标处。
* **直接执行：** 调用 Go 的 `os/exec` 执行，并将标准输出/错误流重定向回当前终端。

通过系统提示词严格告诉大模型的输出格式（json），结果包含两部分：1：命令解释 2：命令本身。输出采用流式输出。

### 3.3 智能上下文感知 (Context Injection)

在向大模型发起请求前，`BaoMiHua` 必须静默收集当前环境信息，组装成 System Prompt，确保生成的命令 100% 适配当前环境。

* **操作系统 (OS)：** 通过 `runtime.GOOS` 识别 (`darwin`, `linux`, `windows`)。
* **Shell 环境：** 读取 `$SHELL` 或 Windows 的 `COMSPEC` (`zsh`, `bash`, `fish`, `powershell`)。
* **工作目录：** 获取当前执行路径 (`pwd`)。

## 4. 边界条件与安全防御 (Safety Guard)

作为直接操作系统的工具，必须具备严格的安全拦截机制（防 AI 幻觉）。

### 4.1 高危命令定义

包含但不限于：`rm -rf /`、`mkfs`、`dd if=/dev/zero`、`chmod -R 777 /` 等直接破坏文件系统或提权的指令。

### 4.2 拦截与 UI 降级策略

1. **静态正则拦截：** 在渲染交互菜单前，将大模型返回的命令经过本地正则黑名单池扫描。
2. **视觉警告：** 若命中高危特征，终端 UI 强制变为**红色高亮**。
* *UI 展示：* `⚠️ 警告：豹米花察觉到极度危险的操作，请谨慎行事！`


3. **动作降级：** 强制在交互菜单中**移除/禁用“2. 直接执行”**选项，只允许用户选择“插入终端”（强迫用户手动复查并敲击回车）或“放弃”。

## 5. 多端配置与模型管理 (Viper 驱动)

遵循严格的配置加载优先级：**命令行 Flag > 环境变量 > 本地配置文件 > 默认值**。

需要支持主流的中国，美国的全部大模型的环境变量配置，并且用业界通用的环境变量名称
ChatGPT、Gemini、文心一言、通义千问、Kimi、Claude、DeepSeek、GLM、Qwen、MiniMax等都需要支持

| 配置项 | 环境变量格式 | 配置文件 (`~/.baomihua.yaml`) | 说明 |
| --- | --- | --- | --- |
| API 密钥 | `BAOMIHUA_API_KEY` | `api-key: "sk-..."` | 必填项。建议通过环境变量配置以保证安全。 |
| 模型名称 | `BAOMIHUA_MODEL` | `model: "gpt-4o"` | 默认模型。支持通过 `bmh --model=xxx` 临时覆盖。 |
| 接口地址 | `BAOMIHUA_BASE_URL` | `base-url: "..."` | 用于支持企业内网代理或本地 Ollama 部署。 |

* **模型列表查看：** `bmh --list` (或 `-l`) 打印当前支持或配置的模型列表。

